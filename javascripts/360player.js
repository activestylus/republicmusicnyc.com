/**
 *
 * SoundManager 2 Demo: 360-degree / "donut player"
 * ------------------------------------------------
 * http://schillmania.com/projects/soundmanager2/
 *
 * An inline player with a circular UI.
 * Based on the original SM2 inline player.
 * Inspired by Apple's preview feature in the
 * iTunes music store (iPhone), among others.
 *
 * Requires SoundManager 2 Javascript API.
 * Also uses Bernie's Better Animation Class (BSD):
 * http://www.berniecode.com/writing/animator.html
 *
*/
/*jslint white: false, onevar: true, undef: true, nomen: false, eqeqeq: true, plusplus: false, bitwise: true, regexp: false, newcap: true, immed: true */
/*global document, window, soundManager, navigator */
var threeSixtyPlayer,ThreeSixtyPlayer;(function(a){function b(){var b=this,c=this,d=soundManager,e=navigator.userAgent,f=e.match(/msie/i),g=e.match(/opera/i),h=e.match(/safari/i),i=e.match(/chrome/i),j=e.match(/firefox/i),k=e.match(/ipad|iphone/i),l=typeof a.G_vmlCanvasManager=="undefined"&&typeof document.createElement("canvas").getContext("2d")!="undefined",m=g||i?359.9:360;this.excludeClass="threesixty-exclude",this.links=[],this.sounds=[],this.soundsByURL=[],this.indexByURL=[],this.lastSound=null,this.lastTouchedSound=null,this.soundCount=0,this.oUITemplate=null,this.oUIImageMap=null,this.vuMeter=null,this.callbackCount=0,this.peakDataHistory=[],this.config={playNext:!1,autoPlay:!1,allowMultiple:!1,loadRingColor:"#ccc",playRingColor:"#000",backgroundRingColor:"#eee",segmentRingColor:"rgba(255,255,255,0.33)",segmentRingColorAlt:"rgba(0,0,0,0.1)",loadRingColorMetadata:"#ddd",playRingColorMetadata:"rgba(128,192,256,0.9)",circleDiameter:null,circleRadius:null,animDuration:500,animTransition:a.Animator.tx.bouncy,showHMSTime:!1,scaleFont:!0,useWaveformData:!1,waveformDataColor:"#0099ff",waveformDataDownsample:3,waveformDataOutside:!1,waveformDataConstrain:!1,waveformDataLineRatio:.64,useEQData:!1,eqDataColor:"#339933",eqDataDownsample:4,eqDataOutside:!0,eqDataLineRatio:.54,usePeakData:!0,peakDataColor:"#ff33ff",peakDataOutside:!0,peakDataLineRatio:.5,useAmplifier:!0,fontSizeMax:null,scaleArcWidth:1,useFavIcon:!1},this.css={sDefault:"sm2_link",sBuffering:"sm2_buffering",sPlaying:"sm2_playing",sPaused:"sm2_paused"},this.addEventHandler=typeof a.addEventListener!="undefined"?function(a,b,c){return a.addEventListener(b,c,!1)}:function(a,b,c){a.attachEvent("on"+b,c)},this.removeEventHandler=typeof a.removeEventListener!="undefined"?function(a,b,c){return a.removeEventListener(b,c,!1)}:function(a,b,c){return a.detachEvent("on"+b,c)},this.hasClass=function(a,b){return typeof a.className!="undefined"?a.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)")):!1},this.addClass=function(a,c){if(!a||!c||b.hasClass(a,c))return!1;a.className=(a.className?a.className+" ":"")+c},this.removeClass=function(a,c){if(!a||!c||!b.hasClass(a,c))return!1;a.className=a.className.replace(new RegExp("( "+c+")|("+c+")","g"),"")},this.getElementsByClassName=function(a,c,d){var e=d||document,f=[],g,h,i=[];if(typeof c!="undefined"&&typeof c!="string"){for(g=c.length;g--;)if(!i||!i[c[g]])i[c[g]]=e.getElementsByTagName(c[g])}else c?i=e.getElementsByTagName(c):i=e.all||e.getElementsByTagName("*");if(typeof c!="string")for(g=c.length;g--;)for(h=i[c[g]].length;h--;)b.hasClass(i[c[g]][h],a)&&f.push(i[c[g]][h]);else for(g=0;g<i.length;g++)b.hasClass(i[g],a)&&f.push(i[g]);return f},this.getParentByNodeName=function(a,b){if(!a||!b)return!1;b=b.toLowerCase();while(a.parentNode&&b!==a.parentNode.nodeName.toLowerCase())a=a.parentNode;return a.parentNode&&b===a.parentNode.nodeName.toLowerCase()?a.parentNode:null},this.getParentByClassName=function(a,c){if(!a||!c)return!1;while(a.parentNode&&!b.hasClass(a.parentNode,c))a=a.parentNode;return a.parentNode&&b.hasClass(a.parentNode,c)?a.parentNode:null},this.getSoundByURL=function(a){return typeof b.soundsByURL[a]!="undefined"?b.soundsByURL[a]:null},this.isChildOfNode=function(a,b){if(!a||!a.parentNode)return!1;b=b.toLowerCase();do a=a.parentNode;while(a&&a.parentNode&&a.nodeName.toLowerCase()!==b);return a&&a.nodeName.toLowerCase()===b?a:null},this.isChildOfClass=function(a,c){if(!a||!c)return!1;while(a.parentNode&&!b.hasClass(a,c))a=b.findParent(a);return b.hasClass(a,c)},this.findParent=function(a){if(!a||!a.parentNode)return!1;a=a.parentNode;if(a.nodeType===2)while(a&&a.parentNode&&a.parentNode.nodeType===2)a=a.parentNode;return a},this.getStyle=function(b,c){try{if(b.currentStyle)return b.currentStyle[c];if(a.getComputedStyle)return document.defaultView.getComputedStyle(b,null).getPropertyValue(c)}catch(d){}return null},this.findXY=function(a){var b=0,c=0;do b+=a.offsetLeft,c+=a.offsetTop;while(!!(a=a.offsetParent));return[b,c]},this.getMouseXY=function(c){c=c?c:a.event,k&&c.touches&&(c=c.touches[0]);if(c.pageX||c.pageY)return[c.pageX,c.pageY];if(c.clientX||c.clientY)return[c.clientX+b.getScrollLeft(),c.clientY+b.getScrollTop()]},this.getScrollLeft=function(){return document.body.scrollLeft+document.documentElement.scrollLeft},this.getScrollTop=function(){return document.body.scrollTop+document.documentElement.scrollTop},this.events={play:function(){c.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=c.css.sPlaying,c.addClass(this._360data.oUIBox,this._360data.className),b.fanOut(this)},stop:function(){c.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className="",b.fanIn(this)},pause:function(){c.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=c.css.sPaused,c.addClass(this._360data.oUIBox,this._360data.className)},resume:function(){c.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=c.css.sPlaying,c.addClass(this._360data.oUIBox,this._360data.className)},finish:function(){var a;c.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className="",this._360data.didFinish=!0,b.fanIn(this),c.config.playNext&&(a=c.indexByURL[this._360data.oLink.href]+1,a<c.links.length&&c.handleClick({target:c.links[a]})),$("ul.playlist").find("li a").removeClass("pressed")},whileloading:function(){this.paused&&b.updatePlaying.apply(this)},whileplaying:function(){b.updatePlaying.apply(this),this._360data.fps++},bufferchange:function(){this.isBuffering?c.addClass(this._360data.oUIBox,c.css.sBuffering):c.removeClass(this._360data.oUIBox,c.css.sBuffering)}},this.stopEvent=function(b){return typeof b!="undefined"&&typeof b.preventDefault!="undefined"?b.preventDefault():typeof a.event!="undefined"&&typeof a.event.returnValue!="undefined"&&(a.event.returnValue=!1),!1},this.getTheDamnLink=f?function(b){return b&&b.target?b.target:a.event.srcElement}:function(a){return a.target},this.handleClick=function(c){if(c.button>1)return!0;var e=b.getTheDamnLink(c),f,g,h,i,j,k;if(e.nodeName.toLowerCase()!=="a"){e=b.isChildOfNode(e,"a");if(!e)return!0}return b.isChildOfClass(e,"ui360")?(f=e.getAttribute("href"),!e.href||!d.canPlayLink(e)||b.hasClass(e,b.excludeClass)?!0:(d._writeDebug("handleClick()"),g=e.href,h=b.getSoundByURL(g),h?h===b.lastSound?h.togglePause():(h.togglePause(),d._writeDebug("sound different than last sound: "+b.lastSound.sID),!b.config.allowMultiple&&b.lastSound&&b.stopSound(b.lastSound)):(i=e.parentNode,j=b.getElementsByClassName("ui360-vis","div",i.parentNode).length,h=d.createSound({id:"ui360Sound"+b.soundCount++,url:g,onplay:b.events.play,onstop:b.events.stop,onpause:b.events.pause,onresume:b.events.resume,onfinish:b.events.finish,onbufferchange:b.events.bufferchange,whileloading:b.events.whileloading,whileplaying:b.events.whileplaying,useWaveformData:j&&b.config.useWaveformData,useEQData:j&&b.config.useEQData,usePeakData:j&&b.config.usePeakData}),k=parseInt(b.getElementsByClassName("sm2-360ui","div",i)[0].offsetWidth,10),h._360data={oUI360:b.getParentByClassName(e,"ui360"),oLink:e,className:b.css.sPlaying,oUIBox:b.getElementsByClassName("sm2-360ui","div",i)[0],oCanvas:b.getElementsByClassName("sm2-canvas","canvas",i)[0],oButton:b.getElementsByClassName("sm2-360btn","span",i)[0],oTiming:b.getElementsByClassName("sm2-timing","div",i)[0],oCover:b.getElementsByClassName("sm2-cover","div",i)[0],circleDiameter:k,circleRadius:k/2,lastTime:null,didFinish:null,pauseCount:0,radius:0,fontSize:1,fontSizeMax:b.config.fontSizeMax,scaleFont:j&&b.config.scaleFont,showHMSTime:j,amplifier:j&&b.config.usePeakData?.9:1,radiusMax:k*.175,width:0,widthMax:k*.4,lastValues:{bytesLoaded:0,bytesTotal:0,position:0,durationEstimate:0},animating:!1,oAnim:new a.Animator({duration:b.config.animDuration,transition:b.config.animTransition,onComplete:function(){}}),oAnimProgress:function(a){var c=this;c._360data.radius=parseInt(c._360data.radiusMax*c._360data.amplifier*a,10),c._360data.width=parseInt(c._360data.widthMax*c._360data.amplifier*a,10),c._360data.scaleFont&&c._360data.fontSizeMax!==null&&(c._360data.oTiming.style.fontSize=parseInt(Math.max(1,c._360data.fontSizeMax*a),10)+"px",c._360data.oTiming.style.opacity=a),(c.paused||c.playState===0||c._360data.lastValues.bytesLoaded===0||c._360data.lastValues.position===0)&&b.updatePlaying.apply(c)},fps:0},typeof b.Metadata!="undefined"&&b.getElementsByClassName("metadata","div",h._360data.oUI360).length&&(h._360data.metadata=new b.Metadata(h,b)),h._360data.scaleFont&&h._360data.fontSizeMax!==null&&(h._360data.oTiming.style.fontSize="1px"),h._360data.oAnim.addSubject(h._360data.oAnimProgress,h),b.refreshCoords(h),b.updatePlaying.apply(h),b.soundsByURL[g]=h,b.sounds.push(h),!b.config.allowMultiple&&b.lastSound&&b.stopSound(b.lastSound),h.play()),b.lastSound=h,typeof c!="undefined"&&typeof c.preventDefault!="undefined"?c.preventDefault():typeof a.event!="undefined"&&(a.event.returnValue=!1),!1)):!0},this.fanOut=function(c){var d=c;if(d._360data.animating===1)return!1;d._360data.animating=0,soundManager._writeDebug("fanOut: "+d.sID+": "+d._360data.oLink.href),d._360data.oAnim.seekTo(1),a.setTimeout(function(){d._360data.animating=0},b.config.animDuration+20)},this.fanIn=function(c){var d=c;if(d._360data.animating===-1)return!1;d._360data.animating=-1,soundManager._writeDebug("fanIn: "+d.sID+": "+d._360data.oLink.href),d._360data.oAnim.seekTo(0),a.setTimeout(function(){d._360data.didFinish=!1,d._360data.animating=0,b.resetLastValues(d)},b.config.animDuration+20)},this.resetLastValues=function(a){a._360data.lastValues.position=0},this.refreshCoords=function(a){a._360data.canvasXY=b.findXY(a._360data.oCanvas),a._360data.canvasMid=[a._360data.circleRadius,a._360data.circleRadius],a._360data.canvasMidXY=[a._360data.canvasXY[0]+a._360data.canvasMid[0],a._360data.canvasXY[1]+a._360data.canvasMid[1]]},this.stopSound=function(a){soundManager._writeDebug("stopSound: "+a.sID),soundManager.stop(a.sID),k||soundManager.unload(a.sID)},this.buttonClick=function(c){var d=c?c.target?c.target:c.srcElement:a.event.srcElement;return b.handleClick({target:b.getParentByClassName(d,"sm2-360ui").nextSibling}),!1},this.buttonMouseDown=function(a){return k?b.addEventHandler(document,"touchmove",b.mouseDown):document.onmousemove=function(a){b.mouseDown(a)},b.stopEvent(a),!1},this.mouseDown=function(c){if(!k&&c.button>1)return!0;if(!b.lastSound)return b.stopEvent(c),!1;var d=c?c:a.event,e,f,g;return k&&d.touches&&(d=d.touches[0]),e=d.target||d.srcElement,f=b.getSoundByURL(b.getElementsByClassName("sm2_link","a",b.getParentByClassName(e,"ui360"))[0].href),b.lastTouchedSound=f,b.refreshCoords(f),g=f._360data,b.addClass(g.oUIBox,"sm2_dragging"),g.pauseCount=b.lastTouchedSound.paused?1:0,b.mmh(c?c:a.event),k?(b.removeEventHandler(document,"touchmove",b.mouseDown),b.addEventHandler(document,"touchmove",b.mmh),b.addEventHandler(document,"touchend",b.mouseUp)):(document.onmousemove=b.mmh,document.onmouseup=b.mouseUp),b.stopEvent(c),!1},this.mouseUp=function(a){var c=b.lastTouchedSound._360data;b.removeClass(c.oUIBox,"sm2_dragging"),c.pauseCount===0&&b.lastTouchedSound.resume(),k?(b.removeEventHandler(document,"touchmove",b.mmh),b.removeEventHandler(document,"touchend",b.mouseUP)):(document.onmousemove=null,document.onmouseup=null)},this.mmh=function(c){typeof c=="undefined"&&(c=a.event);var d=b.lastTouchedSound,e=b.getMouseXY(c),f=e[0],g=e[1],h=f-d._360data.canvasMidXY[0],i=g-d._360data.canvasMidXY[1],j=Math.floor(m-(b.rad2deg(Math.atan2(h,i))+180));return d.setPosition(d.durationEstimate*(j/m)),b.stopEvent(c),!1},this.drawSolidArc=function(a,c,d,e,f,i,j){var k=d,l=d,m=a,n,o,p,q;m.getContext&&(n=m.getContext("2d")),a=n,j||b.clearCanvas(m),c&&(n.fillStyle=c),a.beginPath(),isNaN(f)&&(f=0),o=d-e,p=g||h;if(!p||p&&d>0)a.arc(0,0,d,i,f,!1),q=b.getArcEndpointCoords(o,f),a.lineTo(q.x,q.y),a.arc(0,0,o,f,i,!0),a.closePath(),a.fill()},this.getArcEndpointCoords=function(a,b){return{x:a*Math.cos(b),y:a*Math.sin(b)}},this.deg2rad=function(a){return a*Math.PI/180},this.rad2deg=function(a){return a*180/Math.PI},this.getTime=function(a,b){var c=Math.floor(a/1e3),d=Math.floor(c/60),e=c-d*60;return b?d+":"+(e<10?"0"+e:e):{min:d,sec:e}},this.clearCanvas=function(a){var b=a,c=null,d,e;b.getContext&&(c=b.getContext("2d")),d=b.offsetWidth,e=b.offsetHeight,c.clearRect(-(d/2),-(e/2),d,e)},this.updatePlaying=function(){var a=this._360data.showHMSTime?b.getTime(this.position,!0):parseInt(this.position/1e3,10),c=b.config.scaleArcWidth;this.bytesLoaded&&(this._360data.lastValues.bytesLoaded=this.bytesLoaded,this._360data.lastValues.bytesTotal=this.bytesTotal),this.position&&(this._360data.lastValues.position=this.position),this.durationEstimate&&(this._360data.lastValues.durationEstimate=this.durationEstimate),b.drawSolidArc(this._360data.oCanvas,b.config.backgroundRingColor,this._360data.width,this._360data.radius*c,b.deg2rad(m),!1),b.drawSolidArc(this._360data.oCanvas,this._360data.metadata?b.config.loadRingColorMetadata:b.config.loadRingColor,this._360data.width,this._360data.radius*c,b.deg2rad(m*(this._360data.lastValues.bytesLoaded/this._360data.lastValues.bytesTotal)),0,!0),this._360data.lastValues.position!==0&&b.drawSolidArc(this._360data.oCanvas,this._360data.metadata?b.config.playRingColorMetadata:b.config.playRingColor,this._360data.width,this._360data.radius*c,b.deg2rad(this._360data.didFinish===1?m:m*(this._360data.lastValues.position/this._360data.lastValues.durationEstimate)),0,!0),this._360data.metadata&&this._360data.metadata.events.whileplaying(),a!==this._360data.lastTime&&(this._360data.lastTime=a,this._360data.oTiming.innerHTML=a),(this.instanceOptions.useWaveformData||this.instanceOptions.useEQData)&&l&&b.updateWaveform(this),b.config.useFavIcon&&b.vuMeter&&b.vuMeter.updateVU(this)},this.updateWaveform=function(a){if(!b.config.useWaveformData&&!b.config.useEQData||!d.features.waveformData&&!d.features.eqData)return!1;if(!a.waveformData.left.length&&!a.eqData.length&&!a.peakData.left)return!1;var c=a._360data.oCanvas.getContext("2d"),e=0,f=parseInt(a._360data.circleDiameter/2,10),g=f/2,h=1,i=1,j=0,k=f,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;if(b.config.useWaveformData){o=b.config.waveformDataDownsample,o=Math.max(1,o),p=256,q=p/o,r=0,s=0,t=null,u=b.config.waveformDataOutside?1:b.config.waveformDataConstrain?.5:.565,g=b.config.waveformDataOutside?.7:.75,v=b.deg2rad(360/q*b.config.waveformDataLineRatio);for(l=0;l<p;l+=o)r=b.deg2rad(360*(l/q*1/o)),s=r+v,t=a.waveformData.left[l],t<0&&b.config.waveformDataConstrain&&(t=Math.abs(t)),b.drawSolidArc(a._360data.oCanvas,b.config.waveformDataColor,a._360data.width*u*(2-b.config.scaleArcWidth),a._360data.radius*g*1.25*t,s,r,!0)}if(b.config.useEQData){o=b.config.eqDataDownsample,w=0,o=Math.max(1,o),x=192,q=x/o,u=b.config.eqDataOutside?1:.565,n=b.config.eqDataOutside?-1:1,g=b.config.eqDataOutside?.5:.75,r=0,s=0,v=b.deg2rad(360/q*b.config.eqDataLineRatio),y=b.deg2rad(a._360data.didFinish===1?360:360*(a._360data.lastValues.position/a._360data.lastValues.durationEstimate)),m=0,z=0;for(l=0;l<x;l+=o)r=b.deg2rad(360*(l/x)),s=r+v,b.drawSolidArc(a._360data.oCanvas,s>y?b.config.eqDataColor:b.config.playRingColor,a._360data.width*u,a._360data.radius*g*a.eqData.left[l]*n,s,r,!0)}if(b.config.usePeakData&&!a._360data.animating){A=a.peakData.left||a.peakData.right,x=3;for(l=0;l<x;l++)A=A||a.eqData[l];a._360data.amplifier=b.config.useAmplifier?.9+A*.1:1,a._360data.radiusMax=a._360data.circleDiameter*.175*a._360data.amplifier,a._360data.widthMax=a._360data.circleDiameter*.4*a._360data.amplifier,a._360data.radius=parseInt(a._360data.radiusMax*a._360data.amplifier,10),a._360data.width=parseInt(a._360data.widthMax*a._360data.amplifier,10)}},this.getUIHTML=function(a){return['<canvas class="sm2-canvas" width="'+a+'" height="'+a+'"></canvas>',' <span class="sm2-360btn sm2-360btn-default"></span>',' <div class="sm2-timing'+(navigator.userAgent.match(/safari/i)?" alignTweak":"")+'"></div>',' <div class="sm2-cover"></div>']},this.uiTest=function(a){var c=document.createElement("div"),d,e,f,g,h,i,j,k,l;return c.className="sm2-360ui",d=document.createElement("div"),d.className="ui360"+(a?" "+a:""),e=d.appendChild(c.cloneNode(!0)),d.style.position="absolute",d.style.left="-9999px",f=document.body.appendChild(d),g=e.offsetWidth,h=b.getUIHTML(g),e.innerHTML=h[1]+h[2]+h[3],i=parseInt(e.offsetWidth,10),j=parseInt(i/2,10),l=b.getElementsByClassName("sm2-timing","div",f)[0],k=parseInt(b.getStyle(l,"font-size"),10),isNaN(k)&&(k=null),d.parentNode.removeChild(d),h=d=e=f=null,{circleDiameter:i,circleRadius:j,fontSizeMax:k}},this.init=function(){d._writeDebug("threeSixtyPlayer.init()");var c=b.getElementsByClassName("ui360","div"),e,g,h=[],i=!1,j=0,l,m,n,o,p,q,r,s,t,u,v,w;for(e=0,g=c.length;e<g;e++)h.push(c[e].getElementsByTagName("a")[0]),c[e].style.backgroundImage="none";b.oUITemplate=document.createElement("div"),b.oUITemplate.className="sm2-360ui",b.oUITemplateVis=document.createElement("div"),b.oUITemplateVis.className="sm2-360ui",q=b.uiTest(),b.config.circleDiameter=q.circleDiameter,b.config.circleRadius=q.circleRadius,r=b.uiTest("ui360-vis"),b.config.fontSizeMax=r.fontSizeMax,b.oUITemplate.innerHTML=b.getUIHTML(b.config.circleDiameter).join(""),b.oUITemplateVis.innerHTML=b.getUIHTML(r.circleDiameter).join("");for(e=0,g=h.length;e<g;e++)d.canPlayLink(h[e])&&!b.hasClass(h[e],b.excludeClass)&&!b.hasClass(h[e],b.css.sDefault)&&(b.addClass(h[e],b.css.sDefault),b.links[j]=h[e],b.indexByURL[h[e].href]=j,j++,i=b.hasClass(h[e].parentNode,"ui360-vis"),o=(i?r:q).circleDiameter,p=(i?r:q).circleRadius,s=h[e].parentNode.insertBefore((i?b.oUITemplateVis:b.oUITemplate).cloneNode(!0),h[e]),f&&typeof a.G_vmlCanvasManager!="undefined"?(u=h[e].parentNode,v=document.createElement("canvas"),v.className="sm2-canvas",w="sm2_canvas_"+parseInt(Math.random()*1048576,10),v.id=w,v.width=o,v.height=o,s.appendChild(v),a.G_vmlCanvasManager.initElement(v),l=document.getElementById(w)):l=h[e].parentNode.getElementsByTagName("canvas")[0],n=b.getElementsByClassName("sm2-cover","div",h[e].parentNode)[0],t=h[e].parentNode.getElementsByTagName("span")[0],b.addEventHandler(t,"click",b.buttonClick),k?b.addEventHandler(n,"touchstart",b.mouseDown):b.addEventHandler(n,"mousedown",b.mouseDown),m=l.getContext("2d"),m.translate(p,p),m.rotate(b.deg2rad(-90)));j>0&&(b.addEventHandler(document,"click",b.handleClick),b.config.autoPlay&&b.handleClick({target:b.links[0],preventDefault:function(){}})),d._writeDebug("threeSixtyPlayer.init(): Found "+j+" relevant items."),b.config.useFavIcon&&typeof this.VUMeter!="undefined"&&(this.vuMeter=new this.VUMeter(this))}}b.prototype.VUMeter=function(a){var b=a,c=this,d=document.getElementsByTagName("head")[0],e=navigator.userAgent.match(/opera/i),f=navigator.userAgent.match(/firefox/i);this.vuMeterData=[],this.vuDataCanvas=null,this.setPageIcon=function(a){if(!b.config.useFavIcon||!b.config.usePeakData||!a)return!1;var c=document.getElementById("sm2-favicon");c&&(d.removeChild(c),c=null),c||(c=document.createElement("link"),c.id="sm2-favicon",c.rel="shortcut icon",c.type="image/png",c.href=a,document.getElementsByTagName("head")[0].appendChild(c))},this.resetPageIcon=function(){if(!b.config.useFavIcon)return!1;var a=document.getElementById("favicon");a&&(a.href="/favicon.ico")},this.updateVU=function(a){soundManager.flashVersion>=9&&b.config.useFavIcon&&b.config.usePeakData&&c.setPageIcon(c.vuMeterData[parseInt(16*a.peakData.left,10)][parseInt(16*a.peakData.right,10)])},this.createVUData=function(){var a=0,b=0,d=c.vuDataCanvas.getContext("2d"),e=d.createLinearGradient(0,16,0,0),f=d.createLinearGradient(0,16,0,0),g="rgba(0,0,0,0.2)";e.addColorStop(0,"rgb(0,192,0)"),e.addColorStop(.3,"rgb(0,255,0)"),e.addColorStop(.625,"rgb(255,255,0)"),e.addColorStop(.85,"rgb(255,0,0)"),f.addColorStop(0,g),f.addColorStop(1,"rgba(0,0,0,0.5)");for(a=0;a<16;a++)c.vuMeterData[a]=[];for(a=0;a<16;a++)for(b=0;b<16;b++)c.vuDataCanvas.setAttribute("width",16),c.vuDataCanvas.setAttribute("height",16),d.fillStyle=f,d.fillRect(0,0,7,15),d.fillRect(8,0,7,15),d.fillStyle=e,d.fillRect(0,15-a,7,16-(16-a)),d.fillRect(8,15-b,7,16-(16-b)),d.clearRect(0,3,16,1),d.clearRect(0,7,16,1),d.clearRect(0,11,16,1),c.vuMeterData[a][b]=c.vuDataCanvas.toDataURL("image/png")},this.testCanvas=function(){var a=document.createElement("canvas"),b=null,c;if(!a||typeof a.getContext=="undefined")return null;b=a.getContext("2d");if(!b||typeof a.toDataURL!="function")return null;try{c=a.toDataURL("image/png")}catch(d){return null}return a},this.init=function(){b.config.useFavIcon&&(c.vuDataCanvas=c.testCanvas(),c.vuDataCanvas&&(f||e)?c.createVUData():b.config.useFavIcon=!1)},this.init()},b.prototype.Metadata=function(a,b){soundManager._wD("Metadata()");var c=this,d=a._360data.oUI360,e=d.getElementsByTagName("ul")[0],f=e.getElementsByTagName("li"),g=navigator.userAgent.match(/firefox/i),h=!1,i,j;this.lastWPExec=0,this.refreshInterval=250,this.totalTime=0,this.events={whileplaying:function(){var d=a._360data.width,e=a._360data.radius,f=a.durationEstimate||c.totalTime*1e3,g=null,h,i,j;for(h=0,i=c.data.length;h<i;h++)g=h%2===0,b.drawSolidArc(a._360data.oCanvas,g?b.config.segmentRingColorAlt:b.config.segmentRingColor,g?d:d,g?e/2:e/2,b.deg2rad(360*(c.data[h].endTimeMS/f)),b.deg2rad(360*((c.data[h].startTimeMS||1)/f)),!0);j=new Date,j-c.lastWPExec>c.refreshInterval&&(c.refresh(),c.lastWPExec=j)}},this.refresh=function(){var b,c,d=null,e=a.position,f=a._360data.metadata.data;for(b=0,c=f.length;b<c;b++)if(e>=f[b].startTimeMS&&e<=f[b].endTimeMS){d=b;break}d!==f.currentItem&&d<f.length&&(a._360data.oLink.innerHTML=f.mainTitle+' <span class="metadata"><span class="sm2_divider"> | </span><span class="sm2_metadata">'+f[d].title+"</span></span>",f.currentItem=d)},this.strToTime=function(a){var b=a.split(":"),c=0,d;for(d=b.length;d--;)c+=parseInt(b[d],10)*Math.pow(60,b.length-1-d);return c},this.data=[],this.data.givenDuration=null,this.data.currentItem=null,this.data.mainTitle=a._360data.oLink.innerHTML;for(i=0;i<f.length;i++)this.data[i]={o:null,title:f[i].getElementsByTagName("p")[0].innerHTML,startTime:f[i].getElementsByTagName("span")[0].innerHTML,startSeconds:c.strToTime(f[i].getElementsByTagName("span")[0].innerHTML.replace(/[()]/g,"")),duration:0,durationMS:null,startTimeMS:null,endTimeMS:null,oNote:null};j=b.getElementsByClassName("duration","div",d),this.data.givenDuration=j.length?c.strToTime(j[0].innerHTML)*1e3:0;for(i=0;i<this.data.length;i++)this.data[i].duration=parseInt(this.data[i+1]?this.data[i+1].startSeconds:(c.data.givenDuration?c.data.givenDuration:a.durationEstimate)/1e3,10)-this.data[i].startSeconds,this.data[i].startTimeMS=this.data[i].startSeconds*1e3,this.data[i].durationMS=this.data[i].duration*1e3,this.data[i].endTimeMS=this.data[i].startTimeMS+this.data[i].durationMS,this.totalTime+=this.data[i].duration},navigator.userAgent.match(/webkit/i)&&navigator.userAgent.match(/mobile/i)&&(soundManager.useHTML5Audio=!0),soundManager.html5PollingInterval=50,soundManager.debugMode=a.location.href.match(/debug=1/i),soundManager.consoleOnly=!0,soundManager.flashVersion=9,soundManager.useHighPerformance=!0,soundManager.useFlashBlock=!0,soundManager.debugMode&&a.setInterval(function(){var b=a.threeSixtyPlayer;b&&b.lastSound&&b.lastSound._360data.fps&&typeof a.isHome=="undefined"&&(soundManager._writeDebug("fps: ~"+b.lastSound._360data.fps),b.lastSound._360data.fps=0)},1e3),a.ThreeSixtyPlayer=b})(window),threeSixtyPlayer=new ThreeSixtyPlayer,soundManager.onready(threeSixtyPlayer.init)